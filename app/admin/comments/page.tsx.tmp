"use client";
import { useEffect, useState } from "react";
import { useToast } from "../../components/ToastProvider";

type AdminComment = {
  id: number;
  postSlug: string;
  content: string;
  createdAt: string;
  userId?: number;
  guestName?: string;
  user?: { id: number; name?: string; email?: string; role?: string };
};

export default function AdminCommentsPage() {
  const [me, setMe] = useState<any>(null);
  const [elevated, setElevated] = useState(false);
  const [checkingElevated, setCheckingElevated] = useState(true);
  const [code, setCode] = useState("");

  const [slug, setSlug] = useState("");
  const [userId, setUserId] = useState("");
  const [loading, setLoading] = useState(false);
  const [comments, setComments] = useState<AdminComment[]>([]);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(false);
  const [msg, setMsg] = useState("");

  const { showToast } = useToast();

  // å½“å‰ç”¨æˆ·
  useEffect(() => {
    (async () => {
      try {
        const d = await fetch("/api/me", { cache: "no-store" }).then(
          (r) => r.json(),
        );
        setMe(d.user || null);
      } catch {
        setMe(null);
      }
    })().catch(() => {});
  }, []);

  // æ£€æŸ¥åå°æå‡çŠ¶æ€?  useEffect(() => {
    if (!me || me.role !== "ADMIN") return;
    (async () => {
      try {
        const r = await fetch("/api/admin/status", {
          cache: "no-store",
        });
        if (r.ok) {
          const d = await r.json();
          setElevated(Boolean(d.elevated));
        } else {
          setElevated(false);
        }
      } finally {
        setCheckingElevated(false);
      }
    })().catch(() => {
      setCheckingElevated(false);
    });
  }, [me]);

  async function load(nextPage = 1) {
    if (!elevated) return;
    setLoading(true);
    setMsg("");
    try {
      const params = new URLSearchParams();
      params.set("page", String(nextPage));
      params.set("pageSize", "50");
      if (slug.trim()) params.set("slug", slug.trim());
      if (userId.trim()) {
        const idNum = Number(userId.trim());
        if (!Number.isNaN(idNum) && idNum > 0) {
          params.set("userId", String(idNum));
        }
      }
      const r = await fetch(
        "/api/admin/comments?" + params.toString(),
        { cache: "no-store" },
      );
      if (r.ok) {
        const d = await r.json();
        setComments(d.comments || []);
        setPage(d.page || nextPage);
        setHasMore(Boolean(d.hasMore));
      } else if (r.status === 403) {
        const d = await r.json().catch(() => ({}));
        if (d?.error === "elevation_required") {
          setElevated(false);
          showToast("å®‰å…¨éªŒè¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ç®¡ç†æ“ä½œç ", "info");
        } else {
          setMsg("åŠ è½½å¤±è´¥");
          showToast("åŠ è½½å¤±è´¥", "error");
        }
      } else {
        setMsg("åŠ è½½å¤±è´¥");
        showToast("åŠ è½½å¤±è´¥", "error");
      }
    } finally {
      setLoading(false);
    }
  }

  // æå‡éªŒè¯
  async function verify() {
    const value = code.trim();
    if (!value) {
      showToast("è¯·è¾“å…¥ç®¡ç†æ“ä½œç ", "info");
      return;
    }
    const r = await fetch("/api/admin/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code: value }),
    });
    const d = await r.json().catch(() => ({}));
    if (r.ok && d.ok) {
      setElevated(true);
      setCode("");
      setMsg("");
      showToast("å·²é€šè¿‡åå°å®‰å…¨éªŒè¯", "success");
      load(1);
    } else {
      if (d?.error === "invalid_code") {
        showToast("æ“ä½œç é”™è¯¯ï¼Œè¯·é‡è¯?, "error");
      } else if (d?.error === "missing_code") {
        showToast("è¯·è¾“å…¥ç®¡ç†æ“ä½œç ", "info");
      } else {
        showToast(d?.error || "éªŒè¯å¤±è´¥", "error");
      }
    }
  }

  async function removeComment(c: AdminComment) {
    if (
      !window.confirm(
        `ç¡®å®šè¦åˆ é™¤è¯¥è¯„è®ºå—ï¼Ÿï¼ˆæ–‡ç« ï¼š${c.postSlug}ï¼ŒIDï¼?{c.id}ï¼‰`,
      )
    ) {
      return;
    }
    const r = await fetch(
      `/api/posts/${encodeURIComponent(
        c.postSlug,
      )}/comments?id=${c.id}`,
      { method: "DELETE" },
    );
    if (r.ok) {
      showToast("è¯„è®ºå·²åˆ é™?, "success");
      load(page);
    } else if (r.status === 403) {
      const d = await r.json().catch(() => ({}));
      if (d?.error === "elevation_required") {
        setElevated(false);
        showToast("å®‰å…¨éªŒè¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ç®¡ç†æ“ä½œç ", "info");
      } else {
        showToast("æ— æƒé™æˆ–åˆ é™¤å¤±è´¥", "error");
      }
    } else {
      showToast("åˆ é™¤å¤±è´¥", "error");
    }
  }

  async function banUser(c: AdminComment) {
    if (!c.userId) {
      showToast("è¯¥è¯„è®ºæ²¡æœ‰ç»‘å®šç”¨æˆ?IDï¼Œæ— æ³•å°ç¦ç”¨æˆ?, "info");
      return;
    }
    const minutesRaw =
      window.prompt("å°ç¦å¤šä¹…ï¼Ÿå•ä½ï¼šåˆ†é’Ÿï¼ˆé»˜è®?60 åˆ†é’Ÿï¼?) || "";
    let minutes = Number(minutesRaw);
    if (!minutesRaw.trim()) {
      minutes = 60;
    }
    if (!Number.isFinite(minutes) || minutes <= 0) {
      showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„å°ç¦æ—¶é•¿", "info");
      return;
    }
    const reason =
      window.prompt("å°ç¦åŸå› ï¼ˆå¯é€‰ï¼‰") || "";
    const r = await fetch("/api/admin/comments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: c.userId,
        minutes,
        reason: reason || undefined,
      }),
    });
    const d = await r.json().catch(() => ({}));
    if (r.ok) {
      showToast("å·²å°ç¦è¯¥ç”¨æˆ·çš„è¯„è®ºæƒé™?, "success");
    } else if (r.status === 403) {
      if (d?.error === "elevation_required") {
        setElevated(false);
        showToast("å®‰å…¨éªŒè¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ç®¡ç†æ“ä½œç ", "info");
      } else {
        showToast("æ— æƒé™æˆ–å°ç¦å¤±è´¥", "error");
      }
    } else {
      showToast(d?.error || "å°ç¦å¤±è´¥", "error");
    }
  }

  async function unbanUser(c: AdminComment) {
    if (!c.userId) {
      showToast("è¯¥è¯„è®ºæ²¡æœ‰ç»‘å®šç”¨æˆ?IDï¼Œæ— æ³•è§£å°ç”¨æˆ·è¯„è®ºæƒé™?, "info");
      return;
    }
    if (
      !window.confirm(
        `ç¡®å®šè¦è§£é™¤ç”¨æˆ?ID ${c.userId} çš„è¯„è®ºå°ç¦å—ï¼Ÿ`,
      )
    ) {
      return;
    }
    const r = await fetch("/api/admin/comments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "unban",
        userId: c.userId,
      }),
    });
    const d = await r.json().catch(() => ({}));
    if (r.ok) {
      showToast("å·²è§£é™¤è¯¥ç”¨æˆ·çš„è¯„è®ºå°ç¦?, "success");
    } else if (r.status === 403) {
      if (d?.error === "elevation_required") {
        setElevated(false);
        showToast("å®‰å…¨éªŒè¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ç®¡ç†æ“ä½œç ", "info");
      } else {
        showToast("æ— æƒé™æˆ–è§£å°å¤±è´¥", "error");
      }
    } else {
      showToast(d?.error || "è§£å°å¤±è´¥", "error");
    }
  }

  useEffect(() => {
    if (me?.role === "ADMIN" && elevated) {
      load(1);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [me, elevated]);

  if (!me) return null;
  if (me.role !== "ADMIN") {
    return (
      <div className="container">
        <div className="card">æ— æƒé™è®¿é—®è¯¥é¡µé¢</div>
      </div>
    );
  }

  return (
    <div className="container">
      <section className="section">
        <div className="card" style={{ display: "grid", gap: 10 }}>
          <div style={{ fontWeight: 600, fontSize: 18 }}>
            è¯„è®ºå®¡æ ¸ / å°ç¦
          </div>

          <div
            style={{
              fontSize: 14,
              display: "flex",
              justifyContent: "space-between",
              gap: 8,
              flexWrap: "wrap",
            }}
          >
            <span>
              å½“å‰è´¦å·ï¼?              <span style={{ fontWeight: 500 }}>
                {me.name || me.email || `ç®¡ç†å‘?${me.id}`}
              </span>
            </span>
            <span>
              å®‰å…¨çŠ¶æ€ï¼š
              <span
                style={{
                  fontWeight: 500,
                  color: elevated ? "#4caf50" : "#f97316",
                }}
              >
                {elevated ? "å·²éªŒè¯? : "æœªéªŒè¯?}
              </span>
            </span>
          </div>

          {!checkingElevated && !elevated && (
            <div
              style={{
                display: "flex",
                flexWrap: "wrap",
                gap: 8,
                alignItems: "center",
              }}
            >
              <input
                type="password"
                placeholder="è¾“å…¥ç®¡ç†æ“ä½œç ?
                value={code}
                onChange={(e) => setCode(e.target.value)}
                style={{
                  flex: "1 1 160px",
                  minWidth: 0,
                  padding: "6px 8px",
                  border: "1px solid var(--border)",
                  borderRadius: 6,
                  background: "transparent",
                  color: "var(--text)",
                }}
              />
              <button
                className="nav-link"
                type="button"
                onClick={verify}
                style={{ cursor: "pointer" }}
              >
                éªŒè¯
              </button>
              <span className="hint">
                å®ŒæˆéªŒè¯åæ‰èƒ½æŸ¥çœ‹ä¸ç®¡ç†è¯„è®ºï¼ˆé»˜è®¤æ“ä½œç ä¸?                123456ï¼Œå¯åœ?.env ä¸­é…ç½?ADMIN_OP_CODEï¼‰ã€?              </span>
            </div>
          )}

          <div
            style={{
              display: "flex",
              gap: 8,
              alignItems: "center",
              flexWrap: "wrap",
            }}
          >
            <input
              placeholder="æŒ‰æ–‡ç«?slug ç­›é€‰ï¼ˆå¯é€‰ï¼‰"
              value={slug}
              onChange={(e) => setSlug(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter") {
                  e.preventDefault();
                  load(1);
                }
              }}
              style={{
                flex: "1 1 160px",
                minWidth: 0,
                padding: "6px 8px",
                border: "1px solid var(--border)",
                borderRadius: 6,
                background: "transparent",
                color: "var(--text)",
              }}
              disabled={!elevated}
            />
            <input
              placeholder="æŒ‰ç”¨æˆ?ID ç­›é€‰ï¼ˆå¯é€‰ï¼‰"
              value={userId}
              onChange={(e) => setUserId(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter") {
                  e.preventDefault();
                  load(1);
                }
              }}
              style={{
                flex: "0 0 130px",
                padding: "6px 8px",
                border: "1px solid var(--border)",
                borderRadius: 6,
                background: "transparent",
                color: "var(--text)",
              }}
              disabled={!elevated}
            />
            <button
              type="button"
              className="nav-link"
              onClick={() => load(1)}
              disabled={!elevated}
              style={{ cursor: elevated ? "pointer" : "not-allowed" }}
            >
              æœç´¢
            </button>
          </div>

          {elevated && (
            <div
              style={{
                borderTop: "1px solid var(--border)",
                marginTop: 8,
                paddingTop: 8,
                display: "grid",
                gap: 8,
              }}
            >
              {!comments.length && !loading && (
                <div className="hint">å½“å‰æ¡ä»¶ä¸‹æš‚æ— è¯„è®?/div>
              )}
              {comments.map((c) => (
                <div
                  key={c.id}
                  className="card"
                  style={{
                    padding: 10,
                    display: "grid",
                    gap: 4,
                  }}
                >
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      gap: 8,
                      alignItems: "center",
                    }}
                  >
                    <div
                      style={{
                        fontSize: 14,
                        fontWeight: 500,
                        overflow: "hidden",
                        textOverflow: "ellipsis",
                        whiteSpace: "nowrap",
                      }}
                    >
                      æ–‡ç« ï¼?                      <a
                        href={`/post/${encodeURIComponent(c.postSlug)}`}
                        target="_blank"
                        rel="noreferrer"
                        style={{ color: "var(--link)" }}
                      >
                        {c.postSlug}
                      </a>
                    </div>
                    <div
                      style={{
                        fontSize: 12,
                        color: "var(--muted)",
                        flexShrink: 0,
                      }}
                    >
                      è¯„è®º IDï¼š{c.id}
                    </div>
                  </div>
                  <div
                    style={{
                      display: "flex",
                      flexWrap: "wrap",
                      gap: 8,
                      fontSize: 12,
                      color: "var(--muted)",
                    }}
                  >
                    <span>
                      ç”¨æˆ·ï¼?                      {c.user
                        ? c.user.name ||
                          c.user.email ||
                          `#${c.user.id}`
                        : c.guestName || "è®¿å®¢"}
                    </span>
                    {c.userId && (
                      <span>ç”¨æˆ· IDï¼š{c.userId}</span>
                    )}
                    <span>
                      æ—¶é—´ï¼?                      {new Date(
                        c.createdAt,
                      ).toLocaleString()}
                    </span>
                  </div>
                  <div
                    style={{
                      fontSize: 14,
                      marginTop: 4,
                      overflow: "hidden",
                      textOverflow: "ellipsis",
                      display: "-webkit-box",
                      WebkitLineClamp: 2,
                      WebkitBoxOrient: "vertical",
                    }}
                    title={c.content}
                  >
                    {c.content}
                  </div>
                  <div
                    style={{
                      display: "flex",
                      gap: 8,
                      marginTop: 4,
                      flexWrap: "wrap",
                    }}
                  >
                    <button
                      type="button"
                      className="nav-link"
                      onClick={() => removeComment(c)}
                      style={{ cursor: "pointer" }}
                    >
                      åˆ é™¤è¯„è®º
                    </button>
                    {c.userId && (
                      <button
                        type="button"
                        className="nav-link"
                        onClick={() => banUser(c)}
                        style={{ cursor: "pointer" }}
                      >
                        å°ç¦è¯¥ç”¨æˆ·è¯„è®?                      </button>
                    )}
                    {c.userId && (
                      <button
                        type="button"
                        className="nav-link"
                        onClick={() => unbanUser(c)}
                        style={{ cursor: "pointer" }}
                      >
                        è§£é™¤è¯¥ç”¨æˆ·è¯„è®ºå°ç¦?                      </button>
                    )}
                  </div>
                </div>
              ))}
              {loading && (
                <div className="hint">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™â€?/div>
              )}
              {comments.length > 0 && (
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginTop: 4,
                  }}
                >
                  <button
                    type="button"
                    className="nav-link"
                    disabled={page <= 1 || loading}
                    onClick={() => load(Math.max(1, page - 1))}
                    style={{
                      cursor:
                        page <= 1 || loading
                          ? "not-allowed"
                          : "pointer",
                    }}
                  >
                    ä¸Šä¸€é¡?                  </button>
                  <span className="hint">
                    ç¬?{page} é¡?                    {hasMore ? "ï¼ˆè¿˜æœ‰æ›´å¤šâ€¦ï¼‰" : "ï¼ˆå·²åˆ°æœ«å°¾ï¼‰"}
                  </span>
                  <button
                    type="button"
                    className="nav-link"
                    disabled={!hasMore || loading}
                    onClick={() => load(page + 1)}
                    style={{
                      cursor:
                        !hasMore || loading
                          ? "not-allowed"
                          : "pointer",
                    }}
                  >
                    ä¸‹ä¸€é¡?                  </button>
                </div>
              )}
            </div>
          )}

          {!elevated && !checkingElevated && (
            <div className="hint">
              è¯·å…ˆå®Œæˆåå°å®‰å…¨éªŒè¯åï¼Œå†æŸ¥çœ‹ä¸ç®¡ç†è¯„è®ºã€?            </div>
          )}

          {msg && <div className="hint">{msg}</div>}
        </div>
      </section>
    </div>
  );
}
